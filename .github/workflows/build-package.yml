name: Build plugin package

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Ensure mkpkg is executable
        run: |
          chmod +x src/mkpkg

      - name: Install required packages
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends xz-utils makepkg || true

      - name: Build package (try mkpkg, fallback to tar)
        id: buildpkg
        run: |
          set -e
          mkdir -p pkg
          echo "Trying to run src/mkpkg..."
          if bash src/mkpkg src/suplapm; then
            echo "mkpkg finished"
          else
            echo "mkpkg failed or not available; building fallback package with tar/xz"
            VERSION=$(date +"%Y.%m.%d")
            ARCH="-x86_64"
            PACKAGE="pkg/suplapm-${VERSION}${ARCH}.txz"
            TMPDIR=$(mktemp -d)
            mkdir -p "${TMPDIR}/usr/local/emhttp/plugins/suplapm"
            # copy plugin files
            cp -a src/suplapm/. "${TMPDIR}/usr/local/emhttp/plugins/suplapm/"
            # copy and update plg file so package contains plugin descriptor
            if [ -f suplapm.plg ]; then
              cp suplapm.plg "${TMPDIR}/suplapm.plg"
              sed -i -e "s#\(ENTITY\s*version[^\"]*\).*#\1\"${VERSION}\">#" "${TMPDIR}/suplapm.plg" || true
              sed -i "/##&name/a\###${VERSION}" "${TMPDIR}/suplapm.plg" || true
            fi
            # create txz containing usr/ and the .plg at root
            tar -C "${TMPDIR}" -cJf "${PACKAGE}" usr suplapm.plg
            md5sum "${PACKAGE}" > "pkg/suplapm-${VERSION}${ARCH}.md5"
            rm -rf "${TMPDIR}"
            echo "Fallback package created: ${PACKAGE}"
          fi

      - name: List pkg/
        run: ls -la pkg || true

      - name: Detect created package
        id: detect
        run: |
          set -e
          pkgfile=$(ls -t pkg/*.txz 2>/dev/null | head -n1 || true)
          if [ -n "$pkgfile" ]; then
            echo "package=$pkgfile" >> "$GITHUB_OUTPUT"
            echo "found=1" >> "$GITHUB_OUTPUT"
          else
            echo "found=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit package back to repo (only on manual run)
        if: ${{ github.event_name == 'workflow_dispatch' && steps.detect.outputs.found == '1' }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pkg/*.txz pkg/*.md5 || true
          git commit -m "build: add package from workflow" || echo "no changes to commit"
          git push origin HEAD

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: suplapm-package
          path: pkg/
